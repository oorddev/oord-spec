{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://oord.dev/schemas/manifest_v1.schema.json",
  "title": "Oord Manifest v1",
  "type": "object",
  "required": [
    "spec_version",
    "verification_profile",
    "manifest_version",
    "seal_id",
    "algorithms",
    "sealing_configuration",
    "workset",
    "inventory",
    "exclusions",
    "results_summary",
    "roots",
    "timestamps",
    "signatures",
    "toolchain",
    "outcome",
    "errors"
  ],
  "additionalProperties": false,
  "properties": {
    "spec_version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "verification_profile": { "const": "public_offline_v1" },
    "manifest_version": { "const": "manifest_v1" },
    "seal_id": { "type": "string", "minLength": 8 },
    "created_at": { "type": "string" },
    "dataset_locator": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "uri"],
      "properties": {
        "type": { "type": "string" },
        "uri": { "type": "string" },
        "description": { "type": "string" }
      }
    },
    "algorithms": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "hash",
        "leaf_encoding",
        "merkle_node_encoding",
        "canonicalization",
        "signature",
        "timestamp"
      ],
      "properties": {
        "hash": { "const": "sha256" },
        "leaf_encoding": { "const": "oord-leaf-v1" },
        "merkle_node_encoding": { "const": "oord-merkle-v1" },
        "canonicalization": { "const": "RFC8785-JCS" },
        "signature": { "enum": ["ed25519", "rsa-pss-sha256"] },
        "timestamp": { "const": "rfc3161" }
      }
    },
    "sealing_configuration": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "chunk_size_leaves",
        "ordering",
        "path_normalization",
        "reliability_profile",
        "finalization_policy"
      ],
      "properties": {
        "chunk_size_leaves": { "type": "integer", "minimum": 1 },
        "ordering": { "const": "object_id_path_size_sha256" },
        "path_normalization": { "const": "posix_nfc_no_traversal" },
        "reliability_profile": { "enum": ["R1", "R2", "R3"] },
        "finalization_policy": {
          "const": "final_requires_full_coverage_and_timestamp"
        }
      }
    },
    "workset": {
      "type": "object",
      "additionalProperties": false,
      "required": ["file", "sha256", "record_count", "source"],
      "properties": {
        "file": { "const": "workset.jsonl.gz" },
        "sha256": { "$ref": "#/$defs/sha256hex" },
        "record_count": { "type": "integer", "minimum": 0 },
        "source": {
          "type": "object",
          "additionalProperties": false,
          "required": ["type", "details"],
          "properties": {
            "type": {
              "enum": [
                "storage_snapshot_id",
                "s3_inventory",
                "versioned_listing",
                "live_list_best_effort"
              ]
            },
            "details": {
              "type": "object",
              "minProperties": 1,
              "description": "For s3_inventory: {manifest_key, manifest_sha256}. For storage_snapshot_id: {snapshot_id, timestamp}. For versioned_listing: {source_description}. For live_list_best_effort: {enumeration_start_time, enumeration_end_time}."
            }
          }
        }
      }
    },
    "inventory": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "file",
        "sha256",
        "record_count",
        "file_count",
        "total_bytes",
        "chunk_count"
      ],
      "properties": {
        "file": { "const": "inventory.jsonl.gz" },
        "sha256": { "$ref": "#/$defs/sha256hex" },
        "record_count": { "type": "integer", "minimum": 0 },
        "file_count": { "type": "integer", "minimum": 0 },
        "total_bytes": { "type": "integer", "minimum": 0 },
        "chunk_count": { "type": "integer", "minimum": 0 }
      }
    },
    "exclusions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["exclusion_mode", "exclusion_objects"],
      "properties": {
        "exclusion_mode": { "const": "required" },
        "exclusion_objects": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["type", "name", "sha256"],
            "properties": {
              "type": {
                "enum": [
                  "path_glob",
                  "domain_list",
                  "id_list",
                  "policy_text",
                  "other"
                ]
              },
              "name": { "type": "string", "minLength": 1 },
              "sha256": { "$ref": "#/$defs/sha256hex" },
              "description": { "type": "string" }
            }
          }
        }
      }
    },
    "results_summary": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "file",
        "sha256",
        "record_count",
        "missing_count",
        "conflict_count"
      ],
      "properties": {
        "file": { "const": "results.jsonl.gz" },
        "sha256": { "$ref": "#/$defs/sha256hex" },
        "record_count": { "type": "integer", "minimum": 0 },
        "missing_count": { "type": "integer", "minimum": 0 },
        "conflict_count": { "type": "integer", "minimum": 0 }
      }
    },
    "roots": {
      "type": "object",
      "additionalProperties": false,
      "required": ["dataset_root_sha256"],
      "properties": {
        "dataset_root_sha256": { "$ref": "#/$defs/sha256hex32bytes" },
        "chunk_roots_root_sha256": { "$ref": "#/$defs/sha256hex32bytes" },
        "chunk_roots_file": { "const": "chunk_roots.bin" },
        "chunk_roots_sha256": { "$ref": "#/$defs/sha256hex" }
      }
    },
    "timestamps": {
      "type": "object",
      "additionalProperties": false,
      "required": ["status", "attempts"],
      "properties": {
        "status": { "enum": ["ok", "failed", "not_attempted"] },
        "attempts": { "type": "integer", "minimum": 0 },
        "tsa_url": { "type": "string" },
        "tsr_file": { "const": "timestamps/dataset_root.tsr" },
        "tsr_sha256": { "$ref": "#/$defs/sha256hex" },
        "error_reason_id": { "type": "string" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "status": { "const": "ok" } }
          },
          "then": {
            "required": ["tsa_url", "tsr_file", "tsr_sha256"]
          }
        }
      ]
    },
    "signatures": {
      "type": "object",
      "additionalProperties": false,
      "required": ["suite", "signing_payload_sha256", "manifest_sig_b64"],
      "properties": {
        "suite": { "enum": ["ed25519", "rsa-pss-sha256"] },
        "public_key_hint": { "type": "string" },
        "cert_chain_hint": { "type": "string" },
        "signing_payload_sha256": { "$ref": "#/$defs/sha256hex" },
        "manifest_sig_b64": { "type": "string", "minLength": 16 }
      }
    },
    "toolchain": {
      "type": "object",
      "additionalProperties": false,
      "required": ["oord_seal_version", "oord_verify_version", "openssl_version_min"],
      "properties": {
        "oord_seal_version": { "type": "string" },
        "oord_verify_version": { "type": "string" },
        "openssl_version_min": { "type": "string" },
        "build": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "git_commit": { "type": "string" },
            "build_id": { "type": "string" }
          }
        }
      }
    },
    "outcome": {
      "type": "object",
      "additionalProperties": false,
      "required": ["sealing_outcome"],
      "properties": {
        "sealing_outcome": { "enum": ["FINAL", "NON_FINAL", "ABORTED"] },
        "finality_reason": { "type": "string" }
      }
    },
    "errors": {
      "type": "object",
      "additionalProperties": false,
      "required": ["file", "sha256", "error_count"],
      "properties": {
        "file": { "const": "errors.jsonl" },
        "sha256": { "$ref": "#/$defs/sha256hex" },
        "error_count": { "type": "integer", "minimum": 0 }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "outcome": {
            "properties": { "sealing_outcome": { "const": "FINAL" } }
          }
        }
      },
      "then": {
        "properties": {
          "results_summary": {
            "properties": {
              "missing_count": { "const": 0 },
              "conflict_count": { "const": 0 }
            },
            "required": ["missing_count", "conflict_count"]
          },
          "timestamps": {
            "properties": { "status": { "const": "ok" } },
            "required": ["status"]
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "algorithms": {
            "properties": { "signature": { "const": "ed25519" } }
          }
        }
      },
      "then": {
        "properties": {
          "signatures": { "properties": { "suite": { "const": "ed25519" } } }
        }
      }
    },
    {
      "if": {
        "properties": {
          "algorithms": {
            "properties": { "signature": { "const": "rsa-pss-sha256" } }
          }
        }
      },
      "then": {
        "properties": {
          "signatures": {
            "properties": { "suite": { "const": "rsa-pss-sha256" } }
          }
        }
      }
    }
  ],
  "$defs": {
    "sha256hex": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "sha256hex32bytes": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
  }
}
